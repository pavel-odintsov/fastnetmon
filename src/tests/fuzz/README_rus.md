# Fuzzing

В этом разделе описан процесс фаззинг-тестирования, использованные подходы и методы, включая как успешные, так и неудачные попытки.

## Навигация
--------------------------------

- [Docker Image](#docker-image)
- [CMake](#cmake)
- [Файловая структура](#файловая-структура)
- [Пример запуска фаззинга](#пример-запуска-фаззинга)
- [Другие техники фаззинга](#другие-техники-фаззинга)
- [Техники, которые не дали результата](#техники-которые-не-дали-результата)

## Docker Image
--------------------------------

Скрипт базируется на `tests/Dockerfile.ubuntu-24.04-afl++`.
В этом образе собирается и устанавливается все необходимое для дальнейшего тестирования:

|    Модуль                                   |  Описание                                                   |
|---------------------------------------------|-------------------------------------------------------------|
|   [`AFL++`](https://github.com/AFLplusplus) | Фаззер                                                      |
|   [`casr`](https://github.com/ispras/casr)  | Утилита для проверки, минимазации и кластеризации крашей. Нужен rust |
|   [`desock`](https://github.com/zardus/preeny/) | Утилита для подмены системных вызовов. Используется в проекте для замены вызова функции `socket`, которая принимает данные с интерфейса, на функцию, которая принимает данные из консоли |

Так же в проекте используются санитайзеры (ASAN, UBSAN и др.) для поиска ошибок в динамике.

### Build Docker Image
--------------------------------

Сборка Docker image для тестирования происходит из коренной директории `fastnetmon` и запускается командой: 
```bash
docker  build -f tests/Dockerfile.ubuntu-24.04-afl++ . -t fuzz
```
По завершению сборки буден получен `image` с названием `fuzz`

## Cmake
--------------------------------
В исходный файл `CmakeLists.txt` был добавлен ряд опций, которые позволяю собирать отдельные фаззинг-обертки используя различные опции cmake.
*В таблице опции будут указываться с приставкой `-D`, которая позволяет задать опцию, как аргумент утилиты cmake при запуске из командой строки*


|    Опция                           |  Описание                                                   |
|------------------------------------|-------------------------------------------------------------|
|  `-DENABLE_FUZZ_TEST`              | Сбирает две фаззинг обертки под `AFL++`. Использовать **только с копилятором `afl-c++`** или его вариациями                                                      |
|  `DENABLE_FUZZ_TEST_LIBFUZZER`    | Сбирает две фаззинг обертки под `libfuzzer`. Использовать **с копилятором `clang` или вариациями `afl-c++`**                                                      |
|  `-DENABLE_FUZZ_TEST_DESOCK`       | Дананя опция позволяет реализоват изменение поведения стандартной функции `socket`. Теперь данные будут браться не с сетевого сокета, из потока ввода. **Инструментирует оригинальный исполняемый файл `fastnetmon`** |
|   `-DCMAKE_BUILD_TYPE=Debug`     | Отладочная опция, необходимая для корректной работы отладчиков. Внимание! **Не использовать на релизе и при тестах - будут ложные срабатывания санитайзера на таких функциях, как `assert()`



## Файловая структура
--------------------------------
```
fuzz/
├── README.md
├── README_rus.md        
├── fastnetmon.conf                              
├── parse_sflow_v5_packet_fuzz.cpp               
├── parse_sflow_v5_packet_fuzz_libfuzzer.cpp     
├── process_netflow_packet_v5_fuzz.cpp           
├── process_netflow_packet_v5_fuzz_libfuzzer.cpp 
└──  scripts/                                    
│   ├── minimize_out.sh                          
│   ├── start_fuzz_conf_file.sh                  
│   └── start_fuzz_harness.sh                    
```

### Описание файловов
--------------------------------

| Файл                                    | Описание                                                                                  |
|-----------------------------------------|------------------------------------------------------------------------------------------|
| `README.md`                             | Документация на **английском языке** о фаззинг-тестировании проекта.                                      |
| `README_rus.md`                         | Документация на **русском языке** о фаззинг-тестировании проекта.                                      |
| `fastnetmon.conf`                       | Конфигурационный файл для FastNetMon. Оставлены для работы только протоколы netflow и sflow             |
| `parse_sflow_v5_packet_fuzz.cpp`        | Обертка для фаззинга функции `parse_sflow_v5_packet_fuzz` через `AFL++`.                                   |
| `parse_sflow_v5_packet_fuzz_libfuzzer.cpp` | Обертка для фаззинга функции `parse_sflow_v5_packet_fuzz` через `libfuzzer`.|
| `process_netflow_packet_v5_fuzz.cpp`    | Обертка для фаззинга функции `process_netflow_packet_v5_fuzz` через `AFL++`.                                                                       |
| `process_netflow_packet_v5_fuzz_libfuzzer.cpp` | Обертка для фаззинга функции `process_netflow_packet_v5_fuzz` через `libfuzzer`.                |

| Файл/Директория                         | Описание                                                                                         | Запуск                                                                                              |
|-----------------------------------------|--------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|
| `/scripts/`                             | Директория со скриптами для автоматизации фаззинга.                                              |                                                                                                     |
| `/scripts/minimize_out.sh`              | Скрипт для минимизации, верификации и кластеризации выходных данных (падений).                   | `./minimize_out.sh <path_to_out_directory> <./binary>`                                              |
| `/scripts/start_fuzz_conf_file.sh`      | Скрипт для запуска фаззинга конфигурационных файлов. Запускает несколько сессий tmux.   Использует опции `./fastnetmon --configuration_check --configuration_file`.         | Запускать из текущей директории без дополнительных опций. Окружение создаётся автоматически.         |
| `/scripts/start_fuzz_harness.sh`        | Скрипт для тестирования бинарных файлов, скомпилированных из обёрток в отдельные исполняемые файлы. Предназначен для обёрток, скомпилированных под `AFL++`.    При запуске настраивает окружение, создаёт папки, запускает две сессии tmux с экземплярами фаззера. После окончания фаззинга запускает скрипт `minimize_out.sh` для кластеризации крашей.                                        | `./start_fuzz_harness.sh <path/to/bin>`    Скрипт завершится, если не будет найдено новых путей в течение определённого времени.    По умолчанию время равно 1 часу. Для изменения изменить переменную `TIME` (в секундах) внутри скрипта.                                                          |



## Пример запуска фаззинга
--------------------------------
Запускаем контейнер:
```bash
docker run --privileged -it fuzz  /bin/bash
```

Для запуска фаззинга AFL++ разрешим многопточную работу:
```bash
echo core | tee /proc/sys/kernel/core_pattern
```

При стандратной сборке `docker image` у нас будет папка `build_fuzz`, внутри которой будт скомпилированы для фаззинг-обертки:
- `parse_sflow_v5_packet_fuzz`
- `process_netflow_packet_v5_fuzz`

Для фаззинга их используем скрипт `start_fuzz_harness`:
```bash
/src/tests/fuzz/scripts/start_fuzz_harness.sh ./process_netflow_packet_v5_fuzz
```
Или 
```bash
/src/tests/fuzz/scripts/start_fuzz_harness.sh ./parse_sflow_v5_packet_fuzz
```

После запуска будет создана директория `<bin_name>_fuzz_dir`, внутри которого будут созданы папки `input` и `output`.
Будте запущена сессия `tmux` с двумя вкладками - на каждой будет инстанс фаззера `AFL++`.
Фаззинг будет продолжаться, пока не будет прироста новых путей в течении часа (можно поменять значение внутри скрипта).
Далее сессия tmux будет завершена, начнется кластеризация и проверка падений с помощью скрипта `minimize_out.sh`

## Другие техники фаззинга

### Грубое вмешательство в код с помощью Persistant Mode AFL++
--------------------------------
Фаззер `AFL++` позволяет переписать часть кода по фаззинг, попутно кратно увеличив скорость фаззинга (програма не заавершается после подачи одного набора даннх, а перезапускает цикл с функцией целью несколько раз).

Таким способом можно инструментировать две разных цели:
- `src/netflow_plugin/netflow_collector.cpp : start_netflow_collector(...)`
- `src/sflow_plugin/sflow_collector.cpp : start_sflow_collector(...)`

Как выглядит инструментация:
1. Перед целевой функций добавить конструкцию `__AFL_FUZZ_INIT();`
2. Цикл `while (true)` заменить на `while (__AFL_LOOP(10000))`
3. `char udp_buffer[udp_buffer_size];` заменить на `unsigned char * udp_buffer =__AFL_FUZZ_TESTCASE_BUF;`
4. `int received_bytes = recvfrom(sockfd, udp_buffer, udp_buffer_size, 0, (struct sockaddr*)&client_addr, &address_len);` заменить на int received_bytes = __AFL_FUZZ_TESTCASE_LEN;
5. Собрать с компилятором AFL++ и санитайзерами. Собирать какие-либо обертки не нужно.
6. Запустить фаззинг `afl-fuzz -i in -o out -- ./fastnetmon`


### Техники, которые не дали результата
--------------------------------
| Название            | Описание                                                                                  |
|---------------------|------------------------------------------------------------------------------------------|
| `AFLNet`            | Особенности протокола (отсутствие обратной связи) не дают использовать данный фаззер                                      |
| `desock`            | Инструментация кода успешна, но фаззер не запускается - так же не может собрать обратную связь. Считаю данный способ **перспективным**, необходима корректировка фаззера. |




